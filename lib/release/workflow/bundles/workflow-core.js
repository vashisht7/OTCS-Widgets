csui.define("workflow/models/workitem/workitem.model",["csui/lib/backbone","csui/utils/url","csui/utils/base","csui/lib/underscore","csui/lib/jquery","csui/utils/contexts/factories/connector"],function(e,t,o,i,r,n){var s=e.Model.extend({"defaults":{"id":"","key":"","label":"","custom":!1},"constructor":function(){e.Model.prototype.constructor.apply(this,arguments)},"parse":function(e,t){var o=e.key,i=e.label,r=t.custom?"custom-"+o:"standard-"+o;return{"key":o,"label":i,"id":r,"custom":t.custom}}}),c=e.Collection.extend({"model":s,"constructor":function(){e.Collection.prototype.constructor.apply(this,arguments)}}),a=e.Model.extend({"constructor":function(){e.Model.prototype.constructor.apply(this,arguments)},"_saveChanges":function(e,s){var c=s.options.context.getObject(n),a=c.connection.url.replace("/v1","/v2"),l=s.alpaca.options.form.attributes.action.split("v1"),d=t.combine(a,l[1]),u=r.Deferred(),f={"type":"PUT","url":d,"data":e};return c.makeAjaxCall(f).done(i.bind(function(){u.resolve()},this)).fail(i.bind(function(e){var t=new o.Error(e);u.reject(t)},this)),u}}),l=e.Collection.extend({"model":a,"constructor":function(){e.Collection.prototype.constructor.apply(this,arguments)}}),d=e.Model.extend({"defaults":{"process_id":0,"subprocess_id":0,"task_id":0,"isDraft":!1,"title":"","instructions":"","doc_id":0,"mapsList":[]},"constructor":function(t,o){e.Model.prototype.constructor.apply(this,arguments),o&&o.connector&&o.connector.assignTo(this)},"url":function(){var e=this.connector.connection.url,o=this.get("isDraft"),i=this.get("mapsList"),r=this.get("draft_id"),n=r?r:this.get("process_id");return o||this.get("isDocDraft")||i&&1===i.length?t.combine(e,"/forms/draftprocesses/update?draftprocess_id="+n):t.combine(e,"/forms/processes/tasks/update?process_id="+this.get("process_id")+"&subprocess_id="+this.get("subprocess_id")+"&task_id="+this.get("task_id"))},"parse":function(e){return this.forms=new l(e.forms),this.actions=new c(e.data.actions,{"parse":!0,"custom":!1}),delete e.data.actions,this.customActions=new c(e.data.custom_actions,{"parse":!0,"custom":!0}),delete e.data.custom_actions,e.data},"isFetchable":function(){var e=this.get("doc_id");return e?e:!!this.get("process_id")},"reset":function(e){this.clear(e),i.isUndefined(this.actions)||this.actions.reset(),i.isUndefined(this.customActions)||this.customActions.reset(),i.isUndefined(this.forms)||this.forms.reset()},"title":function(){return this.get("title")},"sendAction":function(e){var o=this.connector.connection.url.replace("/v1","/v2"),n=t.combine(o,"processes",this.get("process_id"),"subprocesses",this.get("subprocess_id"),"tasks",this.get("task_id")),s=r.Deferred(),c=this.get("isDraft"),a=this.get("mapsList"),l=this.get("draft_id"),d=l?l:this.get("process_id");(c||this.get("isDocDraft")||a&&1===a.length)&&(n=t.combine(o,"draftprocesses",d));var u={};e.get("custom")?u.custom_action=e.get("key"):u.action=e.get("key"),void 0!==this.get("comment")&&this.get("comment").length>0&&(u.comment=this.get("comment")),"Delegate"===e.get("key")&&(u.assignee=this.get("assignee").toString()),"Review"===e.get("key")&&(u.assignee=this.get("assignee").toString(),u.assigneeOption=i.isNumber(this.get("assigneeOption"))?this.get("assigneeOption").toString():"0"),this.get("authentication")===!0&&(u.authentication_info=this.get("authentication_info")),void 0!==this.get("duration")&&this.get("duration").length>0&&(u.duration=this.get("duration")),void 0!==this.get("duration_unit")&&this.get("duration_unit").length>0&&(u.duration_unit=this.get("duration_unit"));var f=new FormData;f.append("body",JSON.stringify(u));var p={"type":"PUT","url":n,"data":f,"contentType":!1,"processData":!1};return this.connector.makeAjaxCall(p).done(i.bind(function(e){s.resolve(e.results),this.trigger("workitem:sendon")},this)).fail(i.bind(function(e){s.reject(e)},this)),s},"sendMemberAcceptAction":function(e){var o=this.connector.connection.url.replace("/v1","/v2"),n=t.combine(o,"processes",this.get("process_id"),"subprocesses",this.get("subprocess_id"),"tasks",this.get("task_id"));e=e?e:"accept";var s={"action":e},c=new FormData,a=r.Deferred();c.append("body",JSON.stringify(s));var l={"type":"PUT","url":n,"data":c,"contentType":!1,"processData":!1};return this.connector.makeAjaxCall(l).done(i.bind(function(){a.resolve()},this)).fail(i.bind(function(e){var t=JSON.parse(e.responseText);a.reject(t)},this)),a}});return d}),csui.define("workflow/models/workflow/workflow.model",["csui/lib/backbone","csui/utils/url","csui/utils/base","csui/lib/underscore","csui/lib/jquery","csui/utils/contexts/factories/connector"],function(e,t,o,i,r){var n=e.Model.extend({"defaults":{"workflow_id":0},"constructor":function(t,o){e.Model.prototype.constructor.apply(this,arguments),o&&o.connector&&o.connector.assignTo(this)},"createDraftProcess":function(){var e=this.connector.connection.url.replace("/v1","/v2"),o=t.combine(e,"draftprocesses"),n={"workflow_id":this.get("workflow_id"),"doc_ids":this.get("DocIDs")},s=new FormData,c=r.Deferred();s.append("body",JSON.stringify(n));var a={"type":"POST","url":o,"data":s,"contentType":!1,"processData":!1};return this.connector.makeAjaxCall(a).done(i.bind(function(e){c.resolve(e.results)},this)).fail(i.bind(function(e){c.reject(e.responseJSON.error)},this)),c},"getDocumentWorkflows":function(){var e=function(e){var t="",o=e.doc_id?e.doc_id.split(","):e.DocIDs,n=r("#selectionID");if(i.each(o,function(e){t=t.concat("doc_id").concat("=").concat(e).concat("&")}),e.ParentID&&(t=t.concat("parent_id=").concat(e.ParentID)),e.checkEnabled&&(t=t.concat("&checkEnabled=").concat(e.checkEnabled)),0===n.length){var s=r("#tableview tbody>tr")[0];s&&(r("<input>").attr({"type":"hidden","id":"selectionID","value":i.uniqueId()}).appendTo(s),n=r("#selectionID"))}return n.val()&&(t=t.concat("&selectionID=").concat(n.val())),e.newDocID&&i.each(e.newDocID,function(e){t=t.concat("&newDocID").concat("=").concat(e)}),t},o=this.connector.connection.url.replace("/v1","/v2"),n=t.combine(o,"docworkflows?"+e(this.attributes)),s=r.Deferred(),c={"type":"GET","url":n,"async":this.get("CheckEnable")?!1:!0};return this.connector.makeAjaxCall(c).done(i.bind(function(e){s.resolve(e.results)},this)).fail(i.bind(function(e){s.reject(e)},this)),s},"startWorkflow":function(){var e=this.connector.connection.url.replace("/v1","/v2"),o=t.combine(e,"draftprocesses/startwf"),n={"workflow_id":this.get("workflow_id"),"doc_ids":this.get("DocIDs")},s=new FormData,c=r.Deferred();s.append("body",JSON.stringify(n));var a={"type":"POST","url":o,"data":s,"contentType":!1,"processData":!1};return this.connector.makeAjaxCall(a).done(i.bind(function(e){c.resolve(e.results)},this)).fail(i.bind(function(e){c.reject(e)},this)),c}});return n}),csui.define("workflow/models/workitem/workitem.model.factory",["csui/lib/jquery","csui/lib/underscore","csui/utils/contexts/factories/factory","csui/utils/contexts/factories/connector","workflow/models/workitem/workitem.model","workflow/models/workflow/workflow.model"],function(e,t,o,i,r,n){var s=o.extend({"propertyPrefix":"workitem","constructor":function(e,t){o.prototype.constructor.apply(this,arguments);var s=e.getObject(i,t);this.context=e,this.property=new r(void 0,{"connector":s}),this.workflow=new n(void 0,{"connector":s})},"isFetchable":function(){return this.property.isFetchable()},"fetch":function(o){var i=this.property.get("isDoc"),r=this.property.get("mapsList"),n=e.Deferred();if(!i||this.property.get("process_id")||this.property.get("draft_id")){if(this.property.get("isDocDraft")){var s=this.property.fetch({"silent":!0});return s.done(t.bind(function(e){this.workflow.set("doc_id",this.property.get("doc_id")),this.workflow.set("ParentID",this.property.get("parent_id")),this.workflow.set("isNewDraft",this.property.get("isNewDraft")),this.property.set("workflowType",e.data.workflow_type),this.workflow.getDocumentWorkflows().done(t.bind(function(e){this.property.set({"datafetched":!0},{"silent":!0}),this.property.set("mapsList",e.data),n.resolve(this.property)},this)).fail(t.bind(function(e){n.reject(e)},this))},this)).fail(t.bind(function(e){n.reject(e)},this)),n.promise()}return this.property.fetch(o)}return r&&r.length>0?n.resolve(this.property):(this.workflow.set("doc_id",this.property.get("doc_id")),this.workflow.set("ParentID",this.property.get("parent_id")),this.workflow.set("isNewDraft",this.property.get("isNewDraft")),this.workflow.getDocumentWorkflows().done(t.bind(function(e){this.property.set({"datafetched":!0},{"silent":!0}),this.property.set("mapsList",e.data),n.resolve(this.property)},this)).fail(t.bind(function(e){n.reject(e)},this)),n.promise())}});return s}),csui.define("workflow/commands/defaultactionitems",[],function(){return[{"equals":{"type":[128]},"signature":"InitiateWorkflow","sequence":30},{"equals":{"type":[153]},"signature":"OpenWorkflowStep","sequence":30},{"equals":{"type":[223]},"signature":"openform","sequence":30}]}),csui.define("workflow/widgets/workitem/workitem/impl/nls/lang",{"root":!0,"en-us":!1,"en":!1}),csui.define("workflow/widgets/workitem/workitem/impl/nls/root/lang",{"CloseButtonLabel":"Close","CancelButtonLabel":"Cancel","StartButtonLabel":"Start","ActionFailMessageTitle":'Action "{0}" failed',"ActionFailMessage":'Action "{0}" failed. \n\n{1}',"AssigneePickerLabelTo":"To","AssigneePickerLabelSendTo":"Send to","CommentTextFieldLabelInstructions":"Instructions","CommentTextFieldPlaceholderInstructions":"Add instructions","CommentTextFieldLabelReply":"Reply","CommentTextFieldPlaceholderReply":"Add reply","SubmitLabelSend":"Send","SuccessSendOnMessage":"One workflow submitted by you.","SuccessInitiateMessage":"Start workflow action was successful.","ErrorMessageLoadExtension":"Workflow could not load extension.","MultipleMapsSelectPlaceholder":"Select workflow type","ChangeWorkflowTypeTitle":"Changing Workflow Type","ChangeWorkflowTypeMessage":"Any changes you have made to this step will be lost.","ReserveDocumentMessageTitle":"Document reserved","ReserveDocumentMessageText":"The document {0} is reserved. \nDo you want to continue anyway?","MemberAcceptDialogTitle":"Workflow sent to a group","MemberAcceptDialogMessage":"Click Accept to work on this Workflow. It will be removed from the My Assignments tile of the other group members. It will be available on your My Assignments tile.","MemberAcceptAcceptButtonLabel":"Accept","MemberAcceptCloseButtonLabel":"Close","MemberAcceptedMessage":"This workflow has been accepted by you","MemberAcceptErrorDescription":"This Workflow was accepted by another group member.","MemberAcceptErrorTitle":"Workflow no longer available","DialogModelTitle":"{0}: {1}","WorkflowStepTitle":"Workflow Step : {0}","StartWorkflowTitle":"Start workflow","StartWorkflowSingleMessage":'Clicking OK will initiate the "{0}" workflow. Do you want to continue?'}),csui.define("workflow/commands/initiate.workflow/initiate.workflow",["csui/lib/jquery","csui/lib/underscore","csui/utils/commandhelper","csui/utils/commands/open.classic.page","csui/utils/contexts/factories/application.scope.factory","csui/models/node.actions","csui/dialogs/modal.alert/modal.alert","workflow/models/workitem/workitem.model.factory","workflow/models/workflow/workflow.model","i18n!workflow/widgets/workitem/workitem/impl/nls/lang"],function(e,t,o,i,r,n,s,c,a,l){var d,u,f=i.extend({"defaults":{"signature":"InitiateWorkflow","command_key":["initiateworkflow"],"scope":"single"},"enabled":function(e){var t=o.getJustOneNode(e);return t&&128===t.get("type")&&(t.get("openable")||t.actions.get("initiateworkflow"))},"execute":function(o,i){return this._getActionParameters(o,i).then(t.bind(function(r){var n=r.get("body");if(n=n&&JSON.parse(n),!n||n.showStartStep)return this._intiateWorkflow(o,i,n);var a,d={"centerVertically":!0,"buttons":s.buttons.OkCancel},u=t.str.sformat(l.StartWorkflowSingleMessage,o.nodes.models[0].get("name")),f=o.context||i&&i.context,p={};o.isDoc&&o.mapsList&&o.mapsList.length>0&&(a=f.getModel(c),p.isDoc=o.isDoc,p.docModels=o.docModel,p.parent_id=o.parent_id,p.status=o,p.url_org=o.url_org,p.isNewDraft=!0,a.set(p,{"silent":!0}),a.set({"doc_id":o.doc_id,"doc_names":o.docNames})),s.confirmQuestion(u,l.StartWorkflowTitle,d).always(t.bind(function(t){return t?this._startWorkflow(o,i,n):e.Deferred().resolve()},this))},this))},"_startWorkflow":function(i,n){var s,c=e.Deferred(),f=o.getJustOneNode(i);return i.workflow_parent_id=f.get("parent_id"),1===f.get("type")&&(f=f.original),n&&n.originatingView?s=n.originatingView:i&&i.originatingView&&(s=i.originatingView),s&&s.blockActions(),csui.require(["csui/controls/globalmessage/globalmessage","csui/utils/contexts/factories/connector"],function(){d=arguments[0],u=arguments[1],n=n||{};var e=i.context||n&&n.context,o=e.getObject(u,n),p=new a({"workflow_id":f.get("id"),"DocIDs":i.doc_id},t.extend(n,{"connector":o}));p.startWorkflow().done(t.bind(function(e){var t=l.SuccessInitiateMessage;e&&e.custom_message&&(t=e.custom_message),d.showMessage("success",t),c.resolve()},this)).fail(t.bind(function(e){e.responseJSON&&d.showMessage("error",e.responseJSON.error),c.reject()},this)).always(function(){if(s&&s.unblockActions(),i.isDoc&&i.mapsList&&i.mapsList.length>1){var e=i.context.viewStateModel;e.get("lastRouter")?e.restoreLastRouter():this.options.context.getModel(r).set("id","")}})},function(e){c.reject(e)}),c},"_intiateWorkflow":function(i,r,n){var s=e.Deferred(),l=o.getJustOneNode(i);if(i.workflow_parent_id=l.get("parent_id"),1===l.get("type")&&(l=l.original),n&&n.initiateInSmartView&&n.initiatecmd&&"initiate_in_smartview"===n.initiatecmd)return csui.require(["csui/controls/globalmessage/globalmessage","csui/utils/contexts/factories/connector"],function(){d=arguments[0],u=arguments[1],r=r||{};var e=i.context||r&&r.context,o=e.getObject(u,r),n=new a({"workflow_id":l.get("id"),"DocIDs":i.doc_id},t.extend(r,{"connector":o}));n.createDraftProcess().done(t.bind(function(t){var o=e.getModel(c),r=location.href;if(i.isDoc===!0){var n={};n.isDocDraft=!0,n.docModels=i.docModel,n.parent_id=i.parent_id,n.status=i,n.url_org=i.url_org,n.draft_id=t.draftprocess_id,n.isNewDraft=!0,o.set(n,{"silent":!0}),o.set("doc_id",i.doc_id),o.set("doc_names",i.docNames)}else o.set("isDraft",!0),o.set("url_org",r),o.set("process_id",t.draftprocess_id),o.set("parent_id",i.workflow_parent_id)},this)).fail(t.bind(function(e){d.showMessage("error",e),s.reject()},this))},function(e){s.reject(e)}),s;var f=i.context||r&&r.context,p=f.getModel(c);return r=r||{},p.set("isDoc",i.isDoc),p.set("parent_id",i.parent_id),p.set("doc_id",i.doc_id),p.set("doc_names",i.docNames),i.isDoc===!0&&(r.isDoc=!0,r.doc_id=i.doc_id,r.parent_id=i.parent_id,r.doc_names=i.docNames,r.connector=p.connector),this._navigateTo(l,r)},"_getActionParameters":function(t,i){var r=o.getJustOneNode(t);1===r.get("type")&&(r=r.original);var s;if(r.actions&&(s=r.actions.get(this.get("command_key")[0])),s){var c=e.Deferred();return c.resolve(s),c}var a=new n(void 0,{"connector":r.connector,"nodes":[r.get("id")],"commands":["initiateworkflow"]}),l=t.originatingView||i.originatingView;return l&&l.blockActions&&l.blockActions(),a.fetch().then(function(){var e=a.get(r.get("id")).actions.get("initiateworkflow");return e}).always(function(){l&&l.unblockActions&&l.unblockActions()})},"getUrlQueryParameters":function(t,o){var i;if(o.isDoc===!0){var r={},n=o.connector.connection.url.replace("/api/v1","");r.func="wfinitiation.InitiateWorkflowMap",r.ParentID=o.parent_id,r.DocNames=o.doc_names,r.WFMapsDataID=t.get("id"),r.nexturl=n+"/app"+(-1!==o.parent_id?"/nodes/"+r.ParentID:""),i=e.param(r);var s=o.doc_id.split(",");for(var c in s)i+="&DocID=".concat(s[c])}else i={},i.func="ll",i.objAction="Initiate",i.objId=t.get("id"),i.nexturl=location.href;return i}});return f}),csui.define("workflow/commands/edit.workflow.map/edit.workflow.map",["csui/lib/jquery","csui/lib/underscore","csui/utils/commandhelper","csui/utils/commands/open.classic.page","workflow/models/workitem/workitem.model.factory"],function(e,t,o,i){var r=i.extend({"defaults":{"signature":"EditWorkflowMap","command_key":["editworkflowmap"],"scope":"single"},"execute":function(e,t){var i=o.getJustOneNode(e);return t=t||{},this._navigateTo(i,t)},"getUrlQueryParameters":function(e){var t;return t={},t.func="ll",t.objAction="paint",t.objId=e.get("id"),t}});return r}),csui.define("workflow/commands/initiate.document.workflow/initiate.document.workflow",["csui/lib/jquery","csui/lib/underscore","csui/utils/commandhelper","csui/utils/commands/open.classic.page","csui/models/node/node.model","csui/controls/globalmessage/globalmessage","csui/dialogs/modal.alert/modal.alert","workflow/models/workitem/workitem.model.factory","workflow/models/workflow/workflow.model","i18n!workflow/widgets/workitem/workitem/impl/nls/lang"],function(e,t,o,i,r,n,s,c,a,l){var d,u,f=i.extend({"defaults":{"signature":"InitiateDocumentWorkflow","command_key":["initiatedocumentworkflow"],"scope":"multiple"},"hasCommonWorkflows":function(e){for(var o=e.length,i=0,r=e[0].length;r>i;i++){var n,s=e[0][i];for(n=1;o>n&&t.contains(e[n],s);n++);if(n===o)return!0}return!1},"enabled":function(e){if(!e)return!1;var t,i,r=this.get("command_key"),n=o.getAtLeastOneNode(e).models,s=!1;if(n.length>0&&this.checkPermittedActions(n,r))if(i=[],1===n.length)t=n[0].actions.get("initiatedocumentworkflow").get("wfList"),t&&(s=t.length>0);else if(n.length>1){for(var c=0;c<n.length;c++){if(t=n[c].actions.get("initiatedocumentworkflow").get("wfList"),!(t&&t.length>0)){s=!1;break}s=!0,i.push(t)}s&&(s=this.hasCommonWorkflows(i))}return s},"getDocIds":function(e){var o=[];return t.each(e,function(e){o.push(e.get("id"))}),o},"getDocNames":function(e){var o={};return t.each(e,function(e){o[e.get("id")]=e.get("name")}),o},"getDelimitedString":function(e,o){var i="",r="";return t.each(e,function(e){i=i.concat(r).concat(e),r=o}),i},"getCommonWorkflows":function(o,i){var r=e.Deferred(),n=o.container.connector,s=this.get("scope"),c=i||{},l=this._getNodesByScope(o,s),d=new a({"CheckEnable":!0},t.extend(c,{"connector":n})),u=this.getDocIds(l);d.set("DocIDs",u),d.set("ParentID",o.container.attributes.id),d.set("checkEnabled",i.checkEnabled);var f=this.get("prevNodeSelection");if(f){var p=t.filter(u,function(e){return!t.contains(f,e)});u.length>f.length&&e(u).filter(f).length===f.length?d.set("newDocID",p):(u.length<f.length||1===u.length&&u.length===f.length&&u[0]!==f[0])&&e("#selectionID").length>0&&e("#selectionID").remove()}return d.getDocumentWorkflows().done(t.bind(function(e){this.set("prevEnabledNodeLen",l.length),this.set("prevNodeSelection",u),e.data.length>0?r.resolve():r.reject()},this)).fail(t.bind(function(){this.set("prevEnabledNodeLen",l.length),this.set("prevNodeSelection",u),r.reject()},this)),r.promise()},"execute":function(i,r){var c=o.getAtLeastOneNode(i).models,f=e.Deferred(),p=this,w=this.getDocIds(c),m=this.getDocNames(c),g=this.getDelimitedString(w,","),h=i.container&&i.container.get("id"),k=h?h:-1,_={"DocIDs":w,"ParentID":k};return csui.require(["csui/utils/contexts/factories/connector","csui/utils/contexts/factories/node"],function(){d=arguments[0],u=arguments[1],r=r||{};var e=i.context||r&&r.context,o=e.getObject(d,r),h=new a(_,t.extend(r,{"connector":o}));h.getDocumentWorkflows().done(t.bind(function(d){var h=location.href;if(d.statusMsg)n.showMessage("error",d.statusMsg),f.reject();else{var _,b,v=[];if(b={"isDoc":!0,"docModels":v,"mapsList":d.data,"datafetched":!0,"url_org":h,"parent_id":k,"status":i,"isNewDraft":!0,"doc_id":g,"doc_names":m},1===d.data.length){var D,y=d.data[0],I=new a({"workflow_id":y.DataID,"DocIDs":w},t.extend(r,{"connector":o}));D=e.getModel(u,{"attributes":{"id":y.DataID}}),_=y.WorkflowType,v=this._prepareDocModels(_,c,o),b.docModels=v,D.fetch().done(t.bind(function(){var o=D.actions.get("initiateworkflow"),r=o?JSON.parse(o.get("body")):!1;if(r&&r.showStartStep){if(!r.initiateInSmartView||!r.initiatecmd||"initiate_in_smartview"!==r.initiatecmd)return c.isDoc=!0,c.doc_id=g,c.doc_names=m,c.parent_id=k,p._navigateTo(D,c);I.createDraftProcess().done(t.bind(function(t){_=d.workflow_type,b.draft_id=t.draftprocess_id,this._prepareWorkItem(e,b),f.resolve()},this)).fail(t.bind(function(e){f.reject(e)},this))}else{var c={"centerVertically":!0,"buttons":s.buttons.OkCancel},a=t.str.sformat(l.StartWorkflowSingleMessage,y.Name);s.confirmQuestion(a,l.StartWorkflowTitle,c).always(t.bind(function(e){e?(i.originatingView&&i.originatingView.blockActions(),I.startWorkflow().done(t.bind(function(e){var t=l.SuccessInitiateMessage;e&&e.custom_message&&(t=e.custom_message),n.showMessage("success",t),f.resolve()},this)).fail(t.bind(function(e){n.showMessage("error",e.responseJSON.error),f.reject()},this)).always(function(){i.originatingView&&i.originatingView.unblockActions()})):f.resolve()},this))}},this)).fail(t.bind(function(e){e.responseJSON&&n.showMessage("error",e.responseJSON.error)},this))}else v=this._prepareDocModels(_,c,o),b.docModels=v,this._prepareWorkItem(e,b)}},p)).fail(t.bind(function(e){e.responseJSON&&n.showMessage("error",e.responseJSON.error),f.reject()},this))},function(e){f.reject(e)}),f},"_prepareDocModels":function(e,o,i){var n,s=[];return o&&o.length>0&&t.each(o,function(t){n="101_1"===e?new r({"name":t.attributes.name,"original_id":t.attributes.id},{"connector":i}):new r({"type":1,"type_name":"Shortcut","container":!1,"name":t.attributes.name,"original_id":t.attributes.id,"original_id_expand":t.attributes},{"connector":i}),s.push(n)}),s},"_prepareWorkItem":function(e,t){var o;return o=e.getModel(c),o.set(t),o},"getUrlQueryParameters":function(t,o){var i;if(o.isDoc===!0){var r={},n=o.connector.connection.url.replace("/api/v1","");r.func="wfinitiation.InitiateWorkflowMap",r.ParentID=o.parent_id,r.DocNames=o.doc_names,r.WFMapsDataID=t.get("id"),r.nexturl=n+"/app"+(-1!==o.parent_id?"/nodes/"+r.ParentID:""),i=e.param(r);var s=o.doc_id.split(",");for(var c in s)i+="&DocID=".concat(s[c])}else i={},i.func="ll",i.objAction="Initiate",i.objId=t.get("id"),i.nexturl=location.href;return i}});return f}),csui.define("workflow/commands/open.workitem/open.workitem",["csui/lib/underscore","csui/lib/jquery","csui/utils/commandhelper","csui/utils/commands/open.classic.page","csui/utils/command.error","csui/utils/contexts/factories/connector","workflow/models/workitem/workitem.model.factory"],function(e,t,o,i,r,n,s){var c=i.extend({"defaults":{"signature":"OpenWorkflowStep"},"enabled":function(e){var t=o.getJustOneNode(e);return t&&153===t.get("type")},"execute":function(e,i){var r=o.getJustOneNode(e);if(r.get("workflow_open_in_smart_ui")){i=i||{};var n=e.context||i&&i.context,c=t.Deferred(),a=n.getModel(s);return a.set({"process_id":r.get("workflow_id"),"subprocess_id":r.get("workflow_subworkflow_id"),"task_id":r.get("workflow_subworkflow_task_id"),"url_org":location.href}),c}return this._navigateTo(r,i)},"getUrlQueryParameters":function(e){return{"func":"work.EditTask","workid":e.get("workflow_id"),"subworkid":e.get("workflow_subworkflow_id"),"taskid":e.get("workflow_subworkflow_task_id"),"nexturl":location.href}}});return c}),csui.define("workflow/commands/open.form/open.form",["csui/lib/underscore","csui/utils/commandhelper","csui/utils/commands/open.classic.page","csui/models/node.actions"],function(e,t,o,i){var r=o.extend({"defaults":{"signature":"openform","command_key":["openform"],"scope":"single"},"enabled":function(e){var o=t.getJustOneNode(e);return o&&(o.get("openable")||o.actions.get("openform"))},"execute":function(t,o){return this._getActionParameters(t,o).then(e.bind(function(e){return this._openForm(t,o,e)},this))},"_openForm":function(e,o,i){this.objAction="EditForm";var r=t.getJustOneNode(e);return i&&i.get("body")&&(this.objAction=i.get("body")),this._navigateTo(r,o)},"_getActionParameters":function(e,o){var r=t.getJustOneNode(e),n=new i(void 0,{"connector":r.connector,"nodes":[r.get("id")],"commands":["openform"]}),s=e.originatingView||o.originatingView;return s&&s.blockActions&&s.blockActions(),n.fetch().then(function(){var e=n.get(r.get("id")).actions.get("openform");return e}).always(function(){s&&s.unblockActions&&s.unblockActions()})},"getUrlQueryParameters":function(e){return{"func":"ll","objAction":this.objAction,"objId":e.get("id"),"nexturl":location.href}}});return r}),csui.define("workflow/perspective/routers/workflow.perspective.router",["csui/pages/start/perspective.router","csui/utils/contexts/factories/application.scope.factory","workflow/models/workitem/workitem.model.factory"],function(e,t,o){var i=e.extend({"routes":{"processes/:process_id/:subprocess_id/:task_id":"openProcess","draftprocesses/:draftprocess_id":"openDraftProcess","docworkflows/:doc_id/:parent_id":"openDocumentProcess","docworkflows/:doc_id/:parent_id/draftprocesses/:draftprocess_id":"openDocumentDraftProcess"},"constructor":function(){e.prototype.constructor.apply(this,arguments),this.applicationScope=this.context.getModel(t),this.workItem=this.context.getModel(o),this.listenTo(this.workItem,"change:process_id",this._updateUrl),this.listenTo(this.workItem,"change:doc_id",this._updateUrl)},"openProcess":function(e,t,o){this.workItem.set({"process_id":parseInt(e),"subprocess_id":parseInt(t),"task_id":parseInt(o),"isDraft":!1,"url_org":this.validateURL(this._getUrl())})},"openDraftProcess":function(e){this.workItem.set({"process_id":parseInt(e),"isDraft":!0,"url_org":this.validateURL(this._getUrl())})},"openDocumentProcess":function(e,t){var o=this.workItem.defaults;this.workItem.reset({"silent":!0}),this.workItem.set(o,{"silent":!0}),this.workItem.set({"parent_id":parseInt(t),"isDoc":!0,"doc_id":e,"url_org":this.validateURL(this._getUrl())})},"openDocumentDraftProcess":function(e,t,o){this.workItem.set({"parent_id":parseInt(t),"draft_id":parseInt(o),"isDocDraft":!0,"doc_id":e,"url_org":this.validateURL(this._getUrl())})},"onOtherRoute":function(){this.workItem.reset({"silent":!0})},"_getUrl":function(){var e={};window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(t,o,i){e[o]=i});var t=e.origin_index,o=e.nexturl,i=this.workItem.connector.connection.url.replace("/api/v1",""),r=["func=Personal.Assignments","func=work.Workflows&tabname=Assignments"];if(t>=0&&t<=r.length-1)return i+"?"+r[t];if(o)return decodeURIComponent(o);if(document.referrer){var n=document.referrer;return n.indexOf("/app/")>=0||n.indexOf("?func")>=0?document.referrer:""}return""},"_updateUrl":function(){var e=this.workItem.get("process_id"),t=this.workItem.get("subprocess_id"),o=this.workItem.get("task_id"),i=this.workItem.get("isDraft"),r=this.workItem.get("isDocDraft"),n=this.workItem.get("isDoc"),s=this.workItem.get("mapsList"),c=this.workItem.get("doc_id"),a=this.workItem.get("parent_id"),l=this.workItem.get("draft_id");if(!(e&&c||!c&&!e&&"workflow"!==this.applicationScope.id)){var d="processes";i?(d="draftprocesses",e&&(d+="/"+e)):r||s&&1===s.length?(d="docworkflows",c&&a&&l&&(d+="/"+c+"/"+a+"/draftprocesses/"+l)):n?(d="docworkflows",c&&a&&(d+="/"+c+"/"+a)):(d="processes",e&&(d+="/"+e+"/"+t+"/"+o)),this._routeWithSlashes=!1,this.navigate(d)}},"validateURL":function(e){var t=this.parseURL(e),o=t.hostname.trim();return""===o?e:o.toUpperCase()===location.hostname.trim().toUpperCase()?e:""},"parseURL":function(e){var t=document.createElement("a");return t.href=e,{"source":e,"protocol":t.protocol.replace(":",""),"hostname":t.hostname,"host":t.host,"port":t.port,"query":t.search,"params":function(){for(var e,o={},i=t.search.replace(/^\?/,"").split("&"),r=i.length,n=0;r>n;n++)i[n]&&(e=i[n].split("="),o[e[0]]=e[1]);return o}(),"hash":t.hash.replace("#",""),"segments":t.pathname.replace(/^\//,"").split("/")}}});return i}),csui.define("bundles/workflow-core",["workflow/models/workitem/workitem.model.factory","workflow/commands/defaultactionitems","workflow/commands/initiate.workflow/initiate.workflow","workflow/commands/edit.workflow.map/edit.workflow.map","workflow/commands/initiate.document.workflow/initiate.document.workflow","workflow/commands/open.workitem/open.workitem","workflow/commands/open.form/open.form","workflow/perspective/routers/workflow.perspective.router"],{});
//# sourceMappingURL=workflow-core.js.map